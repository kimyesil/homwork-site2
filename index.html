<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>í‰ë‚´ ì—ë“€í”Œë ‰ìŠ¤ ê³¼ì œì œì¶œ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*,
*::before,
*::after {
  box-sizing: border-box;
}

input, textarea, select {
  width: 100%;
  max-width: 100%;
  border-radius: 10px;
  border: 1px solid #d4d4d8;
  font-size: 14px;
  padding: 10px;
  display: block;
}

body {
  font-family: 'Pretendard', sans-serif;
  background: #eef2ff;
  margin: 0;
  padding: 40px 20px;
  display: flex;
  justify-content: center;
}

.container {
  width: 100%;
  max-width: 750px;
  background: white;
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 0 20px rgba(0,0,0,0.06);
}

h1 {
  margin: 0;
  font-size: 26px;
  font-weight: 700;
}

.button-main {
  width: 100%;
  padding: 14px 18px;
  border-radius: 12px;
  background: #4f46e5;
  color: white;
  font-size: 16px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  margin: 10px 0;
}

.post-card {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 14px;
  padding: 18px 15px;
  margin-bottom: 12px;
  cursor: pointer;
}

.post-title {
  font-size: 17px;
  font-weight: 600;
}

.post-meta {
  color: #6b7280;
  font-size: 13px;
  margin-top: 4px;
}

.page-btn {
  padding: 6px 12px;
  border-radius: 8px;
  border: 1px solid #d4d4d8;
  background: #fff;
  margin: 0 4px;
  cursor: pointer;
}

.page-btn.active {
  background: #4f46e5;
  color: #fff;
  border: none;
}

.notice-box {
  background: #fff8e1;
  border: 1px solid #fddc9e;
  padding: 18px;
  border-radius: 14px;
  margin-bottom: 20px;
}

.notice-header {
  display: flex;
  justify-content: space-between;
  font-weight: 600;
}

#formBox {
  display: none;
  flex-direction: column;
  gap: 12px;
  background: #f9fafb;
  padding: 20px;
  border-radius: 16px;
  margin-top: 16px;
}

</style>
</head>

<body>
<div class="container">

  <h1>í‰ë‚´ ì—ë“€í”Œë ‰ìŠ¤ ê³¼ì œì œì¶œ</h1>
  <p style="color:#6b7280; margin-bottom:20px;">
    ê³¼ì œë¥¼ ì œì¶œí•˜ê³  ì œì¶œëœ ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.
  </p>

  <!-- ê³µì§€ì‚¬í•­ -->
  <div class="notice-box">
    <div class="notice-header">
      <span>ğŸ“¢ ê³µì§€ì‚¬í•­</span>
      <button id="toggleNoticeBtn" style="border:none;background:none;cursor:pointer;font-size:14px;">ë‹«ê¸° â–²</button>
    </div>

    <div id="noticeContent" style="margin-top:10px;">
      â— ì—­ì‚¬ ê°œë… ì•”ê¸° ì™„ë£Œ <br>
      â— ì˜ì–´ ë³¸ë¬¸ 2ì¤„ êµ¬ë¬¸ ë¶„ì„ ì™„ë£Œ <br>
      â— ìˆ˜í•™ ë¬¸ì œí’€ì´ ë° ì˜¤ë‹µ ì •ë¦¬ ì™„ë£Œ <br>
      â€» í•™ìŠµ êµì¬ ì‚¬ì§„ ì²¨ë¶€ í•„ìˆ˜<br><br>
      ì—…ë¡œë“œí•œ ì‚¬ì§„ì€ 24ì‹œê°„ í›„ ìë™ ì‚­ì œë©ë‹ˆë‹¤.
    </div>
  </div>

  <button class="button-main" id="openFormBtn">ê³¼ì œ ì œì¶œí•˜ê¸°</button>

  <!-- ì œì¶œ í¼ -->
  <div id="formBox">
    <input id="school" placeholder="í•™êµ (ì˜ˆ: í‰ë‚´ê³ 1)">
    <input id="name" placeholder="ì´ë¦„ (ì˜ˆ: ì´ë‚˜ì˜)">
    <select id="manager">
      <option value="">ë‹´ë‹¹ ë§¤ë‹ˆì € ì„ íƒ</option>
      <option>ê¹€ì˜ˆì‹¤M</option>
      <option>ë°•ì œë¯¼M</option>
    </select>
    <textarea id="content" placeholder="ì „ë‹¬ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <input id="postPassword" maxlength="4" placeholder="ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬">
    <input type="file" id="fileInput" multiple>
    <button class="button-main" id="submitPost">ì œì¶œí•˜ê¸°</button>
  </div>

  <!-- ê²€ìƒ‰ -->
  <input id="searchName" placeholder="í•™ìƒ ì´ë¦„ ê²€ìƒ‰ (ì˜ˆ: ê¹€ì˜ˆë“€)" style="margin-top:25px;">

  <!-- ëª©ë¡ -->
  <h2 style="margin-top:28px; font-size:20px;">ğŸ“Œ ì œì¶œëœ ê³¼ì œ ëª©ë¡</h2>

  <div id="postList"></div>

  <div id="pagination" style="margin-top:12px;"></div>

</div>

<script>
const SUPABASE_URL = "https://kxbyfldxcrdegnfmzgrm.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4YnlmbGR4Y3JkZWduZm16Z3JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NDU4MDMsImV4cCI6MjA3OTAyMTgwM30.Fj_TNEHxWnHY4TbmGEFzowUJp-5X9Gn7-0eynr8cVr4";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const PAGE_SIZE = 10;

let currentPage = 1;
let totalPages = 1;
let currentSearchName = "";

/* ê³µì§€ í† ê¸€ */
const noticeContent = document.getElementById("noticeContent");
const toggleNoticeBtn = document.getElementById("toggleNoticeBtn");
let collapsed = localStorage.getItem("noticeCollapsed") === "1";

function updateNotice() {
  if (collapsed) {
    noticeContent.style.display = "none";
    toggleNoticeBtn.textContent = "ì—´ê¸° â–¼";
  } else {
    noticeContent.style.display = "block";
    toggleNoticeBtn.textContent = "ë‹«ê¸° â–²";
  }
}
toggleNoticeBtn.onclick = () => {
  collapsed = !collapsed;
  localStorage.setItem("noticeCollapsed", collapsed ? "1" : "0");
  updateNotice();
};
updateNotice();

/* í¼ ì—´ê¸° */
document.getElementById("openFormBtn").onclick = () => {
  const box = document.getElementById("formBox");
  box.style.display = box.style.display === "flex" ? "none" : "flex";
};

/* ê²€ìƒ‰ */
document.getElementById("searchName").addEventListener("input", () => {
  currentSearchName = searchName.value.trim();
  loadPosts(1);
});


/* ì œì¶œ ë²„íŠ¼ */
document.getElementById("submitPost").onclick = async () => {
  const school = school.value.trim();
  const name = name.value.trim();
  const manager = manager.value.trim();
  const content = content.value.trim();
  const password = postPassword.value.trim();
  const files = [...fileInput.files];

  if (!school || !name || !manager || !content) {
    alert("ëª¨ë“  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    return;
  }

  if (!password || password.length !== 4) {
    alert("ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    return;
  }

  let urls = [];
  for (const file of files) {
    const ext = file.name.split(".").pop();
    const path = "homework/" + Date.now() + "_" +
      Math.random().toString(36).slice(2) + "." + ext;

    const { data: up, error: upErr } = await db.storage
      .from("uploads")
      .upload(path, file);

    if (upErr) {
      alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + upErr.message);
      return;
    }

    const { data: pub } = db.storage.from("uploads").getPublicUrl(up.path);
    urls.push(pub.publicUrl);
  }

  const { error } = await db.from("posts").insert({
    school,
    name,
    manager,
    content,
    password,
    file_url: JSON.stringify(urls)
  });

  if (error) {
    alert("ì €ì¥ ì˜¤ë¥˜: " + error.message);
    return;
  }

  alert("ì œì¶œ ì™„ë£Œ!");

  formBox.style.display = "none";
  school.value = "";
  name.value = "";
  manager.value = "";
  content.value = "";
  postPassword.value = "";
  fileInput.value = "";

  loadPosts(1);
};

/* ê¸€ ëª©ë¡ */
async function loadPosts(page = 1) {
  currentPage = page;

  const from = (page - 1) * PAGE_SIZE;
  const to = from + PAGE_SIZE - 1;

  let query = db
    .from("posts")
    .select("*", { count: "exact" })
    .order("created_at", { ascending: false })
    .range(from, to);

  if (currentSearchName) {
    query = query.ilike("name", "%" + currentSearchName + "%");
  }

  const { data: posts, count } = await query;
  totalPages = Math.ceil((count || 0) / PAGE_SIZE);

  const postList = document.getElementById("postList");
  postList.innerHTML = "";

  posts.forEach(p => {
    const div = document.createElement("div");
    div.className = "post-card";
    div.onclick = () => location.href = `view.html?id=${p.id}`;

    div.innerHTML = `
      <div class="post-title">ğŸ”’ ${p.school} - ${p.name}</div>
      <div class="post-meta">${p.manager} Â· ${new Date(p.created_at).toLocaleString()}</div>
    `;
    postList.appendChild(div);
  });

  renderPagination();
}

/* í˜ì´ì§• */
function renderPagination() {
  const box = document.getElementById("pagination");
  box.innerHTML = "";

  if (totalPages <= 1) return;

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.className = "page-btn" + (i === currentPage ? " active" : "");
    btn.onclick = () => loadPosts(i);
    box.appendChild(btn);
  }
}

loadPosts(1);
</script>

</body>
</html>
