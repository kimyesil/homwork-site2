<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í‰ë‚´ ì—ë“€í”Œë ‰ìŠ¤ ê³¼ì œì œì¶œ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Pretendard', system-ui, -apple-system, BlinkMacSystemFont;
      background: #eef2ff;
      margin: 0;
      padding: 40px 20px;
      display: flex;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 750px;
      background: #fff;
      padding: 30px 35px;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.08);
    }
    h1 {
      margin: 0;
      text-align: center;
      font-size: 26px;
      font-weight: 700;
    }
    .subtitle {
      font-size: 14px;
      text-align: center;
      color: #6b7280;
      margin-top: 5px;
      margin-bottom: 25px;
    }
    .button-main {
      padding: 12px 18px;
      border-radius: 10px;
      background: #4f46e5;
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      width: 100%;
    }
    .form {
      margin-top: 20px;
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d4d4d8;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      height: 120px;
      resize: none;
    }
    .post-card {
      background: #f9fafb;
      padding: 15px 18px;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      margin-bottom: 12px;
      cursor: pointer;
    }
    .post-title {
      font-weight: 600;
      font-size: 15px;
    }
    .post-meta {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>í‰ë‚´ ì—ë“€í”Œë ‰ìŠ¤ ê³¼ì œì œì¶œ</h1>
  <p class="subtitle">ê³¼ì œë¥¼ ì œì¶œí•˜ê³  ì œì¶œëœ ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</p>

  <!-- ê³¼ì œ ì œì¶œ ë²„íŠ¼ -->
  <button class="button-main" id="openFormBtn">ê³¼ì œ ì œì¶œí•˜ê¸°</button>

  <!-- ê¸€ì“°ê¸° í¼ -->
  <div class="form" id="formBox">
    <input id="school" placeholder="í•™êµ/í•™ë…„ (ì˜ˆ: ì—ë“€ì¤‘2)">
    <input id="name" placeholder="ì´ë¦„">
    <textarea id="content" placeholder="ì „ë‹¬ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <input type="file" id="fileInput" accept="image/*,video/*">

    <button class="button-main" id="submitPost">ì œì¶œí•˜ê¸°</button>
  </div>

  <h2 style="margin-top:30px;">ğŸ“Œ ì œì¶œëœ ê³¼ì œ ëª©ë¡</h2>
  <div id="postList"></div>
</div>

<script>
  const SUPABASE_URL = "https://kxbyfldxcrdegnfmzgrm.supabase.co";   // âœ… ë„¤ í”„ë¡œì íŠ¸ URL
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4YnlmbGR4Y3JkZWduZm16Z3JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NDU4MDMsImV4cCI6MjA3OTAyMTgwM30.Fj_TNEHxWnHY4TbmGEFzowUJp-5X9Gn7-0eynr8cVr4";

  const { createClient } = supabase;
  const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const openFormBtn = document.getElementById("openFormBtn");
  const formBox = document.getElementById("formBox");
  const submitPost = document.getElementById("submitPost");
  const fileInput = document.getElementById("fileInput");

  openFormBtn.onclick = () => {
    formBox.style.display = formBox.style.display === "flex" ? "none" : "flex";
  };

  submitPost.onclick = async () => {
    const school = document.getElementById("school").value.trim();
    const name = document.getElementById("name").value.trim();
    const content = document.getElementById("content").value.trim();
    const file = fileInput.files[0] || null;

    if (!school || !name || !content) {
      alert("í•™êµ/í•™ë…„, ì´ë¦„, ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      return;
    }

    let fileUrl = null;

    // 1) íŒŒì¼ì´ ìˆìœ¼ë©´ Supabase Storageì— ì—…ë¡œë“œ
    if (file) {
      const ext = file.name.split(".").pop();
      const path = `homework/${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;

      const { data: uploadData, error: uploadError } = await db.storage
        .from("uploads")
        .upload(path, file, {
          cacheControl: "3600",
          upsert: false
        });

      if (uploadError) {
        console.error("ì—…ë¡œë“œ ì˜¤ë¥˜:", uploadError);
        alert("íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + uploadError.message);
        return;
      }

      // âœ… ì—¬ê¸°ì„œ path ê·¸ëŒ€ë¡œ ì¨ì•¼ í•¨
      fileUrl = `${SUPABASE_URL}/storage/v1/object/public/uploads/${uploadData.path}`;
      console.log("ì—…ë¡œë“œ ì„±ê³µ, fileUrl =", fileUrl);
    }

    // 2) posts í…Œì´ë¸”ì— ê¸€ + íŒŒì¼ URL ì €ì¥
    const { error: insertError } = await db.from("posts").insert({
      school,
      name,
      content,
      file_url: fileUrl
    });

    if (insertError) {
      console.error("DB ì €ì¥ ì˜¤ë¥˜:", insertError);
      alert("ê¸€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      return;
    }

    alert("ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!");
    formBox.style.display = "none";
    document.getElementById("school").value = "";
    document.getElementById("name").value = "";
    document.getElementById("content").value = "";
    fileInput.value = "";

    await loadPosts();
  };

  // ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadPosts() {
    const { data, error } = await db
      .from("posts")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) {
      console.error("ëª©ë¡ ë¡œë”© ì˜¤ë¥˜:", error);
      return;
    }

    const box = document.getElementById("postList");
    box.innerHTML = "";

    (data || []).forEach(post => {
      const div = document.createElement("div");
      div.className = "post-card";
      div.onclick = () => {
        window.location.href = `view.html?id=${post.id}`;
      };
      div.innerHTML = `
        <div class="post-title">${post.school} - ${post.name}</div>
        <div class="post-meta">${new Date(post.created_at).toLocaleString()}</div>
      `;
      box.appendChild(div);
    });
  }

  loadPosts();
</script>
</body>
</html>
