<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>e-ìŠ¤í„°ë””í”Œë ‰ìŠ¤</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }
    input,
    textarea,
    select {
      width: 100%;
      max-width: 100%;
      border-radius: 10px;
      border: 1px solid #d4d4d8;
      font-size: 14px;
      padding: 10px;
      display: block;
    }

    body {
      font-family: 'Pretendard', system-ui, -apple-system, BlinkMacSystemFont;
      background: #eef2ff;
      margin: 0;
      padding: 40px 20px;
      display: flex;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 750px;
      background: #fff;
      padding: 30px 35px;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.08);
    }
    h1 {
      margin: 0;
      text-align: center;
      font-size: 26px;
      font-weight: 700;
    }
    .subtitle {
      font-size: 14px;
      text-align: center;
      color: #6b7280;
      margin-top: 5px;
      margin-bottom: 15px;
    }

    /* ê³µì§€ ë°•ìŠ¤ */
    .notice-box {
      background:#fff7d6;
      border:1px solid #facc15;
      padding:14px 16px 10px;
      border-radius:14px;
      margin-top:25px;
      margin-bottom:20px;
      font-size:14px;
      line-height:1.5;
    }
    .notice-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .notice-title {
      font-size:15px;
      font-weight:700;
    }
    .notice-toggle-btn {
      border:none;
      background:transparent;
      font-size:12px;
      color:#92400e;
      cursor:pointer;
      padding:4px 8px;
      border-radius:8px;
    }
    .notice-toggle-btn:hover {
      background:rgba(250,204,21,0.2);
    }
    .notice-content {
      margin-top:4px;
    }

    .button-main {
      padding: 12px 18px;
      border-radius: 10px;
      background: #4f46e5;
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      width: 100%;
      margin-top: 15px;
    }
    .form {
      margin-top: 20px;
      display: none;
      flex-direction: column;
      gap: 10px;
      background:#f9fafb;
      padding:16px 14px;
      border-radius:14px;
    }
    /* ë‚´ìš© ì…ë ¥ì¹¸ì€ ì¡°ê¸ˆ ë” í¬ê²Œ */
    #content {
      height: 160px;
      resize: none;
    }

    .search-input {
      margin-top: 24px;
      margin-bottom: 6px;
    }

    .post-card {
      background: #f9fafb;
      padding: 15px 18px;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      margin-bottom: 12px;
      cursor: pointer;
    }
    .post-title {
      font-weight: 600;
      font-size: 15px;
    }
    .post-meta {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    .pagination {
      margin-top: 16px;
      text-align: center;
    }
    .page-btn {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 8px;
      margin: 0 3px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      background: #ffffff;
    }
    .page-btn.active {
      background: #4f46e5;
      color: #ffffff;
      border-color: #4f46e5;
    }

    /* âœ… í˜ì´ì§€ë„¤ì´ì…˜ ê°œì„ (ì¶”ê°€) */
    .page-btn.ghost {
      background: #f3f4f6;
      color: #374151;
      border-color: #e5e7eb;
    }
    .page-btn:disabled {
      opacity: 0.45;
      cursor: default;
    }
    .page-dots {
      display: inline-block;
      margin: 0 6px;
      color: #6b7280;
      font-size: 13px;
      user-select: none;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>e-ìŠ¤í„°ë””í”Œë ‰ìŠ¤</h1>
  <p class="subtitle">ê³¼ì œë¥¼ ì œì¶œí•˜ê³  ì œì¶œëœ ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</p>

  <!-- ğŸ”¥ ê³µì§€ ì ‘ê¸°/ì—´ê¸° -->
  <div id="noticeBox" class="notice-box">
    <div class="notice-header">
      <div class="notice-title">ğŸ“¢ ê³µì§€ì‚¬í•­</div>
      <button id="toggleNoticeBtn" class="notice-toggle-btn">ë‹«ê¸° â–²</button>
    </div>
    <div id="noticeContent" class="notice-content">
      <br>
      ì´ í˜ì´ì§€ëŠ” <b>ì—ë“€í”Œë ‰ìŠ¤ ìƒë‹´ê´€ë¦¬ ê³¼ì œ ì œì¶œë§Œì„ ìœ„í•œ ê³µê°„</b>ì…ë‹ˆë‹¤.<br><br>

      ì‘ì„± ì˜ˆì‹œ<br>
      â— ì—­ì‚¬ ê°œë… ì•”ê¸° ì™„ë£Œ<br>
      â— ì˜ì–´ ë³¸ë¬¸ 2ì¤„ êµ¬ë¬¸ ë¶„ì„ ì™„ë£Œ<br>
      â— ìˆ˜í•™ ë¬¸ì œí’€ì´ ë° ì˜¤ë‹µ ì •ë¦¬ ì™„ë£Œ<br>
      <b>â€» í•™ìŠµ êµì¬ ì‚¬ì§„ ì²¨ë¶€ í•„ìˆ˜</b><br><br>

      <b style="color:#d97706;">ê°œì¸ í•™ìŠµ ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ ì—…ë¡œë“œí•œ ì‚¬ì§„ì€ 24ì‹œê°„ í›„ ìë™ ì‚­ì œë©ë‹ˆë‹¤.</b>
    </div>
  </div>

  <button class="button-main" id="openFormBtn">ê³¼ì œ ì œì¶œí•˜ê¸°</button>

  <!-- ğŸ”¥ ê¸€ì“°ê¸° í¼ -->
  <div class="form" id="formBox">
    <input id="school" placeholder="í•™êµ/í•™ë…„ (ì˜ˆ: ì—ë“€ì¤‘2)">
    <input id="name" placeholder="ì´ë¦„">

    <select id="manager">
      <option value="">ë‹´ë‹¹ ë§¤ë‹ˆì € ì„ íƒ</option>
      <option value="ê¹€ì˜ˆì‹¤M">ê¹€ì˜ˆì‹¤M</option>
      <option value="ë°•ì œë¯¼M">ë°•ì œë¯¼M</option>
    </select>

    <textarea id="content" placeholder="ì „ë‹¬ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>

    <!-- ğŸ” ë¹„ë°€ë²ˆí˜¸ -->
    <input id="postPassword"
           type="password"
           maxlength="4"
           placeholder="ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ (ì˜ˆ: 1234)"
           style="margin-top:5px;">

    <input type="file" id="fileInput" accept="image/*,video/*" multiple>

    <button class="button-main" id="submitPost">ì œì¶œí•˜ê¸°</button>
  </div>

  <!-- ğŸ” ì´ë¦„ ê²€ìƒ‰ -->
  <input id="searchName" class="search-input" placeholder="í•™ìƒ ì´ë¦„ ê²€ìƒ‰ (ì˜ˆ: ê¹€ì˜ˆë“€)">

  <h2 style="margin-top:18px;">ğŸ“Œ ì œì¶œëœ ê³¼ì œ ëª©ë¡</h2>
  <div id="postList"></div>
  <div id="pagination" class="pagination"></div>
</div>

<script>
  const SUPABASE_URL = "https://kxbyfldxcrdegnfmzgrm.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4YnlmbGR4Y3JkZWduZm16Z3JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NDU4MDMsImV4cCI6MjA3OTAyMTgwM30.Fj_TNEHxWnHY4TbmGEFzowUJp-5X9Gn7-0eynr8cVr4";

  const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const PAGE_SIZE = 10;
  let currentPage = 1;
  let totalPages = 1;
  let currentSearchName = "";

  // ğŸ”¥ ì´ë©”ì¼ ì•Œë¦¼ ê¸°ëŠ¥ ON
  const ENABLE_EMAIL = true;
  const FUNCTION_URL =
    "https://kxbyfldxcrdegnfmzgrm.supabase.co/functions/v1/new-post-email";

  async function sendEmail(info) {
    try {
      await fetch(FUNCTION_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_ANON_KEY,
          Authorization: "Bearer " + SUPABASE_ANON_KEY
        },
        body: JSON.stringify(info)
      });
    } catch (e) {
      console.log("ì´ë©”ì¼ ì „ì†¡ ì˜¤ë¥˜(ë¬´ì‹œ ê°€ëŠ¥)", e);
    }
  }

  // ê³µì§€ ì—´ê¸°/ë‹«ê¸°
  const noticeContent = document.getElementById("noticeContent");
  const toggleNoticeBtn = document.getElementById("toggleNoticeBtn");
  let collapsed = localStorage.getItem("noticeCollapsed") === "1";

  function updateNotice() {
    if (collapsed) {
      noticeContent.style.display = "none";
      toggleNoticeBtn.textContent = "ì—´ê¸° â–¼";
    } else {
      noticeContent.style.display = "block";
      toggleNoticeBtn.textContent = "ë‹«ê¸° â–²";
    }
  }

  toggleNoticeBtn.onclick = () => {
    collapsed = !collapsed;
    localStorage.setItem("noticeCollapsed", collapsed ? "1" : "0");
    updateNotice();
  };
  updateNotice();

  // í¼ í† ê¸€
  document.getElementById("openFormBtn").onclick = () => {
    const box = document.getElementById("formBox");
    box.style.display = box.style.display === "flex" ? "none" : "flex";
  };

  // ì´ë¦„ ê²€ìƒ‰
  const searchInput = document.getElementById("searchName");
  searchInput.addEventListener("input", () => {
    currentSearchName = searchInput.value.trim();
    loadPosts(1);
  });

  // ğŸ”¥ ì œì¶œí•˜ê¸° ë²„íŠ¼
  document.getElementById("submitPost").onclick = async () => {
    const schoolInput   = document.getElementById("school");
    const nameInput     = document.getElementById("name");
    const managerSelect = document.getElementById("manager");
    const contentInput  = document.getElementById("content");
    const pwInput       = document.getElementById("postPassword");
    const fileInput     = document.getElementById("fileInput");

    const school  = schoolInput.value.trim();
    const name    = nameInput.value.trim();
    const manager = managerSelect.value.trim();
    const content = contentInput.value.trim();
    const password = pwInput.value.trim();
    const files   = [...fileInput.files];

    if (!school || !name || !manager || !content) {
      alert("ëª¨ë“  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      return;
    }

    if (!password || password.length !== 4) {
      alert("ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      return;
    }

    // (í•„ìš”í•˜ë©´ ì‚¬ì§„ í•„ìˆ˜ë¡œ ê°•ì œ)
    // if (files.length === 0) {
    //   alert("í•™ìŠµ êµì¬ ì‚¬ì§„ì„ ìµœì†Œ 1ì¥ ì²¨ë¶€í•´ì£¼ì„¸ìš”!");
    //   return;
    // }

    // íŒŒì¼ ì—…ë¡œë“œ
    const urls = [];
    for (const file of files) {
      const ext = file.name.split(".").pop();
      const path = `homework/${Date.now()}_${Math.random()
        .toString(36)
        .slice(2)}.${ext}`;

      const { data: up, error: upErr } = await db.storage
        .from("uploads")
        .upload(path, file);

      if (upErr) {
        console.error(upErr);
        alert("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: " + upErr.message);
        return;
      }

      const { data: pub } = db.storage
        .from("uploads")
        .getPublicUrl(up.path);

      urls.push(pub.publicUrl);
    }

    // DB ì €ì¥
    const { error } = await db.from("posts").insert({
      school,
      name,
      manager,
      content,
      file_url: JSON.stringify(urls),
      password
    });

    if (error) {
      console.error(error);
      alert("ì €ì¥ ì˜¤ë¥˜: " + error.message);
      return;
    }

    if (ENABLE_EMAIL) sendEmail({ school, name, manager });

    alert("ì œì¶œ ì™„ë£Œ!");

    document.getElementById("formBox").style.display = "none";
    schoolInput.value = "";
    nameInput.value = "";
    managerSelect.value = "";
    contentInput.value = "";
    pwInput.value = "";
    fileInput.value = "";

    loadPosts(1);
  };

  // ğŸ”¥ ëŒ“ê¸€ ìˆ˜ê¹Œì§€ í¬í•¨í•´ì„œ ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadPosts(page = 1) {
    currentPage = page;

    const from = (page - 1) * PAGE_SIZE;
    const to = from + PAGE_SIZE - 1;

    let query = db
      .from("posts")
      .select("*", { count: "exact" })
      .order("created_at", { ascending: false })
      .range(from, to);

    if (currentSearchName) {
      query = query.ilike("name", "%" + currentSearchName + "%");
    }

    const { data: posts, count, error } = await query;

    if (error) {
      console.error(error);
      alert("ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      return;
    }

    totalPages = Math.ceil((count || 0) / PAGE_SIZE);

    // ê° ê¸€ë³„ ëŒ“ê¸€ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
    const postsWithCounts = await Promise.all(
      (posts || []).map(async (p) => {
        const { count: c } = await db
          .from("comments")
          .select("*", { count: "exact", head: true })
          .eq("post_id", p.id);

        return { ...p, commentCount: c || 0 };
      })
    );

    const box = document.getElementById("postList");
    box.innerHTML = "";

    postsWithCounts.forEach((p) => {
      const div = document.createElement("div");
      div.className = "post-card";
      div.onclick = () => {
        window.location.href = `view.html?id=${p.id}`;
      };

      const commentLabel = p.commentCount
        ? ` <span style="color:#3B82F6; font-weight:600;">(${p.commentCount})</span>`
        : "";

      div.innerHTML = `
        <div class="post-title">ğŸ”’ ${p.school} - ${p.name}${commentLabel}</div>
        <div class="post-meta">${p.manager} Â· ${new Date(
          p.created_at
        ).toLocaleString()}</div>
      `;
      box.appendChild(div);
    });

    renderPagination();
  }

  /* âœ… í˜ì´ì§€ë„¤ì´ì…˜(êµì²´) */
  function renderPagination() {
    const box = document.getElementById("pagination");
    box.innerHTML = "";

    if (!totalPages || totalPages <= 1) return;

    const isMobile = window.matchMedia("(max-width: 480px)").matches;
    const windowSize = isMobile ? 3 : 7;

    const makeBtn = (label, page, opts = {}) => {
      const { disabled = false, active = false, ghost = false } = opts;

      const btn = document.createElement("button");
      btn.textContent = label;
      btn.className =
        "page-btn" +
        (active ? " active" : "") +
        (ghost ? " ghost" : "");

      if (disabled) {
        btn.disabled = true;
      } else {
        btn.onclick = () => loadPosts(page);
      }
      return btn;
    };

    const makeDots = () => {
      const span = document.createElement("span");
      span.textContent = "â€¦";
      span.className = "page-dots";
      return span;
    };

    const atFirst = currentPage === 1;
    const atLast = currentPage === totalPages;

    // âŸª ë§¨ì²˜ìŒ, âŸ¨ ì´ì „
    box.appendChild(makeBtn("âŸª", 1, { disabled: atFirst, ghost: true }));
    box.appendChild(makeBtn("âŸ¨", currentPage - 1, { disabled: atFirst, ghost: true }));

    // ê°€ìš´ë° ìœˆë„ìš° ë²”ìœ„ ê³„ì‚°
    let start = Math.max(1, currentPage - Math.floor(windowSize / 2));
    let end = start + windowSize - 1;

    if (end > totalPages) {
      end = totalPages;
      start = Math.max(1, end - windowSize + 1);
    }

    // ì•ìª½ 1 + â€¦
    if (start > 1) {
      box.appendChild(makeBtn("1", 1, { active: currentPage === 1 }));
      if (start > 2) box.appendChild(makeDots());
    }

    // ì‹¤ì œ í˜ì´ì§€ë“¤
    for (let i = start; i <= end; i++) {
      box.appendChild(makeBtn(String(i), i, { active: i === currentPage }));
    }

    // ë’¤ìª½ â€¦ + last
    if (end < totalPages) {
      if (end < totalPages - 1) box.appendChild(makeDots());
      box.appendChild(makeBtn(String(totalPages), totalPages, { active: currentPage === totalPages }));
    }

    // âŸ© ë‹¤ìŒ, âŸ« ë§¨ë
    box.appendChild(makeBtn("âŸ©", currentPage + 1, { disabled: atLast, ghost: true }));
    box.appendChild(makeBtn("âŸ«", totalPages, { disabled: atLast, ghost: true }));
  }

  loadPosts(1);
</script>
</body>
</html>
