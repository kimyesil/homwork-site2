<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê³¼ì œ ìƒì„¸ë³´ê¸°</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
.file-scroll {
  display: flex;
  overflow-x: auto;
  gap: 10px;
  padding-bottom: 10px;
}
.file-scroll::-webkit-scrollbar {
  height: 8px;
}
.file-scroll::-webkit-scrollbar-thumb {
  background: #c7c7c7;
  border-radius: 4px;
}
.file-item {
  flex: 0 0 auto;
  width: 250px;
  border-radius: 12px;
}

/* ì „ì²´ ë ˆì´ì•„ì›ƒ */
body {
  font-family: 'Pretendard', sans-serif;
  background: #eef2ff;
  margin: 0;
  padding: 40px 20px;
  display: flex;
  justify-content: center;
}
.container {
  width: 100%;
  max-width: 750px;
  background: #fff;
  padding: 30px 35px;
  border-radius: 20px;
  box-shadow: 0 0 20px rgba(0,0,0,0.08);
}
h1 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}
.meta {
  margin-top: 6px;
  color: #6b7280;
  font-size: 14px;
}

/* ğŸ” ë¹„ë°€ë²ˆí˜¸ ë°•ìŠ¤ */
.password-box {
  margin-top: 15px;
  padding: 15px;
  background: #fff3f3;
  border-radius: 14px;
  border: 1px solid #fecaca;
}
.password-box p {
  margin: 0 0 10px;
  font-size: 14px;
}
.password-input {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #e5e7eb;
  font-size: 14px;
  box-sizing: border-box;
}

/* ë³¸ë¬¸ / íŒŒì¼ */
.content-box {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  padding: 15px 20px;
  border-radius: 15px;
  margin-top: 18px;
  white-space: pre-wrap;
  line-height: 1.6;
}
.file-box {
  margin-top: 18px;
}
.file-scroll img,
.file-scroll video {
  width: 250px;
  border-radius: 12px;
  margin-top: 10px;
  flex: 0 0 auto;
  display: block;
}

/* ëŒ“ê¸€ ì˜ì—­ */
.comment-section {
  margin-top: 30px;
}
.comment-card {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  padding: 12px 15px;
  border-radius: 14px;
  margin-bottom: 10px;
}
.comment-meta {
  font-size: 12px;
  color: #6b7280;
}
.comment-text {
  margin-top: 4px;
  font-size: 14px;
}

/* ëŒ“ê¸€ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ */
.comment-actions {
  margin-top: 6px;
  text-align: right;
}
.comment-btn {
  font-size: 11px;
  padding: 3px 7px;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
  background: #f3f4f6;
  cursor: pointer;
  margin-left: 4px;
}
.comment-btn:hover {
  background: #e5e7eb;
}
.comment-btn.delete {
  color: #b91c1c;
  border-color: #fecaca;
  background: #fef2f2;
}
.comment-btn.delete:hover {
  background: #fee2e2;
}

input, textarea {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #d4d4d8;
  font-size: 14px;
  margin-top: 6px;
  box-sizing: border-box;
}
textarea {
  height: 80px;
  resize: none;
}
.button-main {
  margin-top: 10px;
  padding: 12px 18px;
  border-radius: 10px;
  background: #4f46e5;
  color: #fff;
  font-size: 15px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  width: 100%;
}
.delete-btn {
  background: #ef4444 !important;
  margin-top: 10px;
}
.back-btn {
  margin-top: 20px;
  text-align: center;
}
.back-btn a {
  text-decoration: none;
  color: #4f46e5;
  font-size: 14px;
}

/* ğŸ” ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ */
.image-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.image-modal-img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.image-modal-close {
  position: fixed;
  top: 18px;
  right: 22px;
  color: #fff;
  font-size: 26px;
  cursor: pointer;
}
</style>
</head>

<body>
<div class="container">

  <h1>ê³¼ì œ ìƒì„¸ë³´ê¸°</h1>
  <div class="meta" id="postMeta">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <!-- ğŸ” ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ë°•ìŠ¤ -->
  <div id="passwordBox" class="password-box" style="display:none;">
    <p>ğŸ” ì´ ê¸€ì€ ë¹„ë°€ë²ˆí˜¸ê°€ ìˆì–´ì•¼ ì—´ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
    ê¸€ ì‘ì„± ì‹œ ì„¤ì •í•œ ë¹„ë°€ë²ˆí˜¸ ë˜ëŠ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
    <input id="inputPassword" class="password-input" type="password" maxlength="4"
           placeholder="ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬">
    <button class="button-main" id="checkPwBtn" style="margin-top:10px;">í™•ì¸</button>
  </div>

  <!-- ë‚´ìš©/íŒŒì¼ ì˜ì—­ (ì²˜ìŒì—” ì ê¸ˆ ì²˜ë¦¬) -->
  <div class="content-box" id="postContent" style="display:none;"></div>
  <div class="file-box" id="fileBox" style="display:none;"></div>

  <!-- ì‚­ì œ ë²„íŠ¼ -->
  <button class="button-main delete-btn" id="deleteBtn">ê¸€ ì‚­ì œí•˜ê¸°</button>

  <!-- ëŒ“ê¸€ ì˜ì—­ -->
  <div class="comment-section" id="commentSection" style="display:none;">
    <h2 style="font-size:18px;margin-bottom:10px;">ğŸ’¬ ëŒ“ê¸€</h2>

    <div id="commentList"></div>

    <input id="commentName" placeholder="ì´ë¦„">
    <textarea id="commentText" placeholder="ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <button class="button-main" id="commentBtn">ëŒ“ê¸€ ë‹¬ê¸°</button>
  </div>

  <div class="back-btn">
    <a href="index.html">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>
</div>

<!-- ğŸ” ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
  <span class="image-modal-close" onclick="closeImageModal(); event.stopPropagation();">Ã—</span>
  <img id="modalImage" class="image-modal-img" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€">
</div>

<script>
const SUPABASE_URL = "https://kxbyfldxcrdegnfmzgrm.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4YnlmbGR4Y3JkZWduZm16Z3JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NDU4MDMsImV4cCI6MjA3OTAyMTgwM30.Fj_TNEHxWnHY4TbmGEFzowUJp-5X9Gn7-0eynr8cVr4";
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// URLì—ì„œ post id
const postId = new URLSearchParams(window.location.search).get("id");

// ğŸ” ê´€ë¦¬ì ë§ˆìŠ¤í„° ë¹„ë²ˆ
const MASTER_PASSWORD = "3208";

// ì´ ê¸€ì˜ ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸
let postPassword = "";

// ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadPost() {
  const { data, error } = await db
    .from("posts")
    .select("*")
    .eq("id", postId)
    .single();

  if (!data || error) {
    document.getElementById("postMeta").textContent = "ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  document.getElementById("postMeta").textContent =
    `${data.school} Â· ${data.name} Â· ${new Date(data.created_at).toLocaleString()} Â· ${data.manager}`;

  document.getElementById("postContent").textContent = data.content || "";
  postPassword = data.password || "";

  // ì²¨ë¶€íŒŒì¼ í‘œì‹œ
  const box = document.getElementById("fileBox");
  box.innerHTML = "";

  if (data.file_url) {
    let urls = [];

    try {
      const parsed = JSON.parse(data.file_url);
      if (Array.isArray(parsed)) urls = parsed;
      else if (typeof parsed === "string") urls = [parsed];
    } catch {
      urls = [data.file_url];
    }

    const scrollBox = document.createElement("div");
    scrollBox.className = "file-scroll";

    urls.forEach((u) => {
      const urlLower = u.toLowerCase();

      if (
        urlLower.endsWith(".jpg") ||
        urlLower.endsWith(".jpeg") ||
        urlLower.endsWith(".png") ||
        urlLower.endsWith(".gif") ||
        urlLower.endsWith(".webp")
      ) {
        const img = document.createElement("img");
        img.src = u;
        img.className = "file-item";
        img.style.cursor = "pointer";
        img.onclick = () => openImageModal(u);
        scrollBox.appendChild(img);
      } else if (
        urlLower.endsWith(".mp4") ||
        urlLower.endsWith(".mov") ||
        urlLower.endsWith(".avi")
      ) {
        const video = document.createElement("video");
        video.src = u;
        video.controls = true;
        video.className = "file-item";
        scrollBox.appendChild(video);
      } else {
        const a = document.createElement("a");
        a.href = u;
        a.target = "_blank";
        a.textContent = "ì²¨ë¶€íŒŒì¼ ì—´ê¸°";
        a.style.flex = "0 0 auto";
        a.style.marginTop = "10px";
        scrollBox.appendChild(a);
      }
    });

    box.appendChild(scrollBox);
  }

  // ë¹„ë°€ë²ˆí˜¸ ìœ ë¬´ì— ë”°ë¼ ì ê¸ˆ ì²˜ë¦¬
  if (postPassword) {
    document.getElementById("passwordBox").style.display = "block";
    document.getElementById("postContent").style.display = "none";
    document.getElementById("fileBox").style.display = "none";
    document.getElementById("commentSection").style.display = "none";
  } else {
    unlockView();
  }
}

// ğŸ”“ ì ê¸ˆ í•´ì œ
function unlockView() {
  document.getElementById("passwordBox").style.display = "none";
  document.getElementById("postContent").style.display = "block";
  document.getElementById("fileBox").style.display = "block";
  document.getElementById("commentSection").style.display = "block";
}

// ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ë²„íŠ¼
document.getElementById("checkPwBtn").onclick = () => {
  const inputPw = document.getElementById("inputPassword").value.trim();

  if (!inputPw) {
    alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    return;
  }

  if (inputPw === postPassword || inputPw === MASTER_PASSWORD) {
    unlockView();
  } else {
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!");
  }
};

// ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadComments() {
  const { data } = await db
    .from("comments")
    .select("*")
    .eq("post_id", postId)
    .order("created_at", { ascending: true });

  const box = document.getElementById("commentList");
  box.innerHTML = "";

  (data || []).forEach(c => {
    const div = document.createElement("div");
    div.className = "comment-card";
    div.innerHTML = `
      <div class="comment-meta">${c.name} Â· ${new Date(c.created_at).toLocaleString()}</div>
      <div class="comment-text" id="comment-text-${c.id}">${c.text}</div>
      <div class="comment-actions">
        <button class="comment-btn" onclick="editComment('${c.id}')">ìˆ˜ì •</button>
        <button class="comment-btn delete" onclick="deleteComment('${c.id}')">ì‚­ì œ</button>
      </div>
    `;
    box.appendChild(div);
  });
}

// ëŒ“ê¸€ ì‘ì„±
document.getElementById("commentBtn").onclick = async () => {
  const name = document.getElementById("commentName").value.trim();
  const text = document.getElementById("commentText").value.trim();

  if (!name || !text) {
    alert("ì´ë¦„ê³¼ ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    return;
  }

  const { error } = await db.from("comments").insert({
    post_id: postId,
    name,
    text
  });

  if (!error) {
    document.getElementById("commentName").value = "";
    document.getElementById("commentText").value = "";
    loadComments();
  } else {
    alert("ëŒ“ê¸€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
};

// ğŸ”§ ëŒ“ê¸€ ìˆ˜ì •
async function editComment(id) {
  const textEl = document.getElementById(`comment-text-${id}`);
  if (!textEl) return;

  const current = textEl.textContent;
  const updated = prompt("ìˆ˜ì •í•  ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.", current);

  if (updated === null) return; // ì·¨ì†Œ
  if (!updated.trim()) {
    alert("ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
    return;
  }

  const { error } = await db
    .from("comments")
    .update({ text: updated.trim() })
    .eq("id", id);

  if (error) {
    alert("ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  } else {
    loadComments();
  }
}

// ğŸ—‘ ëŒ“ê¸€ ì‚­ì œ
async function deleteComment(id) {
  if (!confirm("ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  const { error } = await db
    .from("comments")
    .delete()
    .eq("id", id);

  if (error) {
    alert("ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  } else {
    loadComments();
  }
}

// ê¸€ ì‚­ì œí•˜ê¸° (ë¹„ë°€ë²ˆí˜¸ í•„ìš”)
document.getElementById("deleteBtn").onclick = async () => {
  const pw = prompt("ì‚­ì œë¥¼ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì‘ì„± ë¹„ë°€ë²ˆí˜¸ ë˜ëŠ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸):");

  if (!pw) {
    alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    return;
  }

  if (postPassword) {
    if (pw !== postPassword && pw !== MASTER_PASSWORD) {
      alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!");
      return;
    }
  } else {
    if (pw !== MASTER_PASSWORD) {
      alert("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì•„ë‹™ë‹ˆë‹¤. ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
  }

  if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  const { error } = await db
    .from("posts")
    .delete()
    .eq("id", postId);

  if (error) {
    alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  } else {
    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    window.location.href = "index.html";
  }
};

/* ğŸ” ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° */
function openImageModal(src) {
  const modal = document.getElementById("imageModal");
  const img = document.getElementById("modalImage");
  img.src = src;
  modal.style.display = "flex";
}
function closeImageModal() {
  const modal = document.getElementById("imageModal");
  modal.style.display = "none";
}

// ì´ˆê¸° ë¡œë”©
loadPost();
loadComments();
</script>
</body>
</html>
