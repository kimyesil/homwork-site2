<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê³¼ì œ ìƒì„¸ë³´ê¸°</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: 'Pretendard', sans-serif;
  background: #eef2ff;
  margin: 0;
  padding: 40px 20px;
  display: flex;
  justify-content: center;
}

.file-box {
  margin-top: 16px;   /* ì›í•˜ë©´ 20~24ë¡œ ë” í‚¤ì›Œë„ ë¼ */
}

.container {
  width: 100%;
  max-width: 750px;
  background: #fff;
  padding: 30px 35px;
  border-radius: 20px;
  box-shadow: 0 0 20px rgba(0,0,0,0.08);
}

h1 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

.meta {
  margin-top: 6px;
  color: #6b7280;
  font-size: 14px;
}

/* íŒŒì¼ ìŠ¤í¬ë¡¤ */
.file-scroll {
  display: flex;
  overflow-x: auto;
  gap: 10px;
  padding-bottom: 10px;
}
.file-scroll::-webkit-scrollbar {
  height: 8px;
}
.file-scroll::-webkit-scrollbar-thumb {
  background: #c7c7c7;
  border-radius: 4px;
}
.file-item {
  flex: 0 0 auto;
  width: 250px;
  border-radius: 12px;
}

/* ë¹„ë°€ë²ˆí˜¸ ë°•ìŠ¤ */
.password-box {
  margin-top: 15px;
  padding: 15px;
  background: #fff3f3;
  border-radius: 14px;
  border: 1px solid #fecaca;
}
.password-input {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #e5e7eb;
  font-size: 14px;
}

/* ë³¸ë¬¸ */
.content-box {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  padding: 15px 20px;
  border-radius: 15px;
  margin-top: 18px;
  white-space: pre-wrap;
  line-height: 1.6;
}

/* ëŒ“ê¸€ */
.comment-input-box {
  display: flex;
  flex-direction: column;  /* âœ… ì„¸ë¡œ ì •ë ¬ */
  gap: 8px;
  margin-top: 15px;
}

/* ì´ë¦„ì€ ìœ„ì—, í­ì€ 100%, ë†’ì´ëŠ” ê¸°ë³¸ ì¸í’‹ ì •ë„ */
.comment-input-name {
  width: 100%;
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid #d4d4d8;
  font-size: 14px;
}

/* ë‚´ìš© ì¹¸ì€ ì•„ë˜, ë†’ì´ ê·¸ëŒ€ë¡œ */
.comment-input-text {
  width: 100%;
  padding: 10px;
  height: 80px;
  border-radius: 10px;
  border: 1px solid #d4d4d8;
  font-size: 14px;
  resize: none;
}

.comment-section {
  margin-top: 30px;
}
.comment-card {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  padding: 12px 15px;
  border-radius: 14px;
  margin-bottom: 10px;
}
.comment-meta {
  font-size: 12px;
  color: #6b7280;
}
.comment-text {
  margin-top: 4px;
  font-size: 14px;
}

.comment-actions {
  margin-top: 6px;
  text-align: right;
}
.comment-btn {
  font-size: 11px;
  padding: 3px 7px;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
  background: #f3f4f6;
  cursor: pointer;
  margin-left: 4px;
}
.comment-btn.delete {
  color: #b91c1c;
  border-color: #fecaca;
  background: #fef2f2;
}

/* ë²„íŠ¼ */
.button-main {
  margin-top: 10px;
  padding: 12px 18px;
  border-radius: 10px;
  background: #4f46e5;
  color: #fff;
  font-size: 15px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  width: 100%;
}

/* ìˆ˜ì • / ì‚­ì œ ë²„íŠ¼ ì •ë ¬ */
.edit-delete-box {
  display: flex;
  gap: 10px;
  margin-top: 18px;
}

.small-btn {
  flex: 1;
  padding: 10px 0;
  border-radius: 10px;
  background: #e5e7eb;
  color: #374151;
  font-size: 14px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  text-align: center;
}

.small-btn:hover {
  background: #d1d5db;
}

.small-btn.delete {
  background: #fca5a5;
  color: #7f1d1d;
}

.small-btn.delete:hover {
  background: #f87171;
}

/* ë’¤ë¡œê°€ê¸° */
.back-btn {
  margin-top: 20px;
  text-align: center;
}
.back-btn a {
  text-decoration: none;
  color: #4f46e5;
}

/* ì´ë¯¸ì§€ ëª¨ë‹¬ */
.image-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.image-modal-img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 16px;
}
.image-modal-close {
  position: fixed;
  top: 18px;
  right: 22px;
  color: #fff;
  font-size: 26px;
  cursor: pointer;
}

/* ìŠ¬ë¼ì´ë“œ í™”ì‚´í‘œ */
.modal-arrow {
  position: fixed;
  top: 50%;
  transform: translateY(-50%);
  font-size: 32px;
  color: #fff;
  background: rgba(0,0,0,0.2);
  border: none;
  border-radius: 999px;
  width: 44px;
  height: 44px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.modal-arrow:hover {
  background: rgba(0,0,0,0.4);
}
.modal-arrow.prev {
  left: 20px;
}
.modal-arrow.next {
  right: 20px;
}

</style>
</head>

<body>
<div class="container">

  <h1>ê³¼ì œ ìƒì„¸ë³´ê¸°</h1>
  <div class="meta" id="postMeta">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <!-- ë¹„ë°€ë²ˆí˜¸ ë°•ìŠ¤ -->
  <div id="passwordBox" class="password-box" style="display:none;">
    <p>ğŸ” ì´ ê¸€ì€ ë¹„ë°€ë²ˆí˜¸ê°€ ìˆì–´ì•¼ ì—´ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
    ê¸€ ì‘ì„± ì‹œ ì„¤ì •í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
    <input id="inputPassword" class="password-input" type="password" maxlength="4" placeholder="ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬">
    <button class="button-main" id="checkPwBtn">í™•ì¸</button>
  </div>

  <div class="content-box" id="postContent" style="display:none;"></div>
  <div class="file-box" id="fileBox" style="display:none;"></div>

  <!-- ê¸€ ìˆ˜ì • / ì‚­ì œ -->
  <div class="edit-delete-box">
    <button class="small-btn" id="editBtn">ê¸€ ìˆ˜ì •í•˜ê¸°</button>
    <button class="small-btn delete" id="deleteBtn">ê¸€ ì‚­ì œí•˜ê¸°</button>
  </div>

  <!-- ëŒ“ê¸€ -->
  <div class="comment-section" id="commentSection" style="display:none;">
    <h2 style="font-size:18px;">ğŸ’¬ ëŒ“ê¸€</h2>
    <div id="commentList"></div>

    <div class="comment-input-box">
      <input id="commentName" class="comment-input-name" placeholder="ì´ë¦„">
      <textarea id="commentText" class="comment-input-text" placeholder="ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    </div>
    <button class="button-main" id="commentBtn">ëŒ“ê¸€ ë‹¬ê¸°</button>
  </div>

  <div class="back-btn"><a href="index.html">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a></div>
</div>

<!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
  <span class="image-modal-close" onclick="closeImageModal(); event.stopPropagation();">Ã—</span>
  <button type="button" class="modal-arrow prev" onclick="showPrevImage(event)">â€¹</button>
  <img id="modalImage" class="image-modal-img" src="">
  <button type="button" class="modal-arrow next" onclick="showNextImage(event)">â€º</button>
</div>

<script>
const SUPABASE_URL = "https://kxbyfldxcrdegnfmzgrm.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4YnlmbGR4Y3JkZWduZm16Z3JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NDU4MDMsImV4cCI6MjA3OTAyMTgwM30.Fj_TNEHxWnHY4TbmGEFzowUJp-5X9Gn7-0eynr8cVr4";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* íŒŒë¼ë¯¸í„° */
const postId = new URLSearchParams(location.search).get("id");
const MASTER_PASSWORD = "3208";

let postPassword = "";
let editing = false;

/* ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë“œìš© */
let imageUrls = [];
let currentImageIndex = 0;

/* ê²Œì‹œê¸€ ë¡œë“œ */
async function loadPost() {
  const { data, error } = await db.from("posts").select("*").eq("id", postId).single();

  if (!data) {
    postMeta.textContent = "ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  postMeta.textContent =
    `${data.school} Â· ${data.name} Â· ${new Date(data.created_at).toLocaleString()} Â· ${data.manager}`;

  postContent.textContent = data.content;
  postPassword = data.password || "";

  /* íŒŒì¼ ì²˜ë¦¬ */
  const box = fileBox;
  box.innerHTML = "";
  imageUrls = [];

  if (data.file_url) {
    let urls = [];
    try {
      urls = JSON.parse(data.file_url);
    } catch {
      urls = [data.file_url];
    }

    const scroll = document.createElement("div");
    scroll.className = "file-scroll";

    urls.forEach((u) => {
      if (/\.(jpg|jpeg|png|gif|webp)$/i.test(u)) {
        const imgIndex = imageUrls.length;
        imageUrls.push(u);

        const img = document.createElement("img");
        img.src = u;
        img.className = "file-item";
        img.style.cursor = "pointer";
        img.onclick = (e) => {
          e.stopPropagation();
          openImageModal(imgIndex);
        };
        scroll.appendChild(img);
      } else if (/\.(mp4|mov|avi)$/i.test(u)) {
        const video = document.createElement("video");
        video.src = u;
        video.controls = true;
        video.className = "file-item";
        scroll.appendChild(video);
      }
    });

    box.appendChild(scroll);
  }

  /* ë¹„ë°€ë²ˆí˜¸ ì ê¸ˆ */
  if (postPassword) {
    passwordBox.style.display = "block";
  } else {
    unlock();
  }
}

/* ì ê¸ˆ í•´ì œ */
function unlock() {
  passwordBox.style.display = "none";
  postContent.style.display = "block";
  fileBox.style.display = "block";
  commentSection.style.display = "block";
}

/* ë¹„ë²ˆ ì²´í¬ */
checkPwBtn.onclick = () => {
  const pw = inputPassword.value.trim();

  if (pw === postPassword || pw === MASTER_PASSWORD) {
    unlock();
  } else {
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!");
  }
};

/* ëŒ“ê¸€ ë¡œë“œ */
async function loadComments() {
  const { data } = await db.from("comments")
    .select("*")
    .eq("post_id", postId)
    .order("created_at");

  commentList.innerHTML = "";

  (data || []).forEach(c => {
    const div = document.createElement("div");
    div.className = "comment-card";
    div.innerHTML = `
      <div class="comment-meta">${c.name} Â· ${new Date(c.created_at).toLocaleString()}</div>
      <div class="comment-text" id="comment-text-${c.id}">${c.text}</div>
      <div class="comment-actions">
        <button class="comment-btn" onclick="editComment('${c.id}')">ìˆ˜ì •</button>
        <button class="comment-btn delete" onclick="deleteComment('${c.id}')">ì‚­ì œ</button>
      </div>`;
    commentList.appendChild(div);
  });
}

/* ëŒ“ê¸€ ì‘ì„± */
commentBtn.onclick = async () => {
  const name = commentName.value.trim();
  const text = commentText.value.trim();

  if (!name || !text) return alert("ì´ë¦„ê³¼ ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

  await db.from("comments").insert({ post_id: postId, name, text });
  commentName.value = "";
  commentText.value = "";
  loadComments();
};

/* ëŒ“ê¸€ ìˆ˜ì • */
async function editComment(id) {
  const current = document.getElementById(`comment-text-${id}`).textContent;
  const updated = prompt("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”", current);

  if (!updated?.trim()) return;
  await db.from("comments").update({ text: updated.trim() }).eq("id", id);
  loadComments();
}

/* ëŒ“ê¸€ ì‚­ì œ */
async function deleteComment(id) {
  if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
  await db.from("comments").delete().eq("id", id);
  loadComments();
}

/* ê¸€ ì‚­ì œ */
deleteBtn.onclick = async () => {
  const pw = prompt("ì‘ì„± ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
  if (!pw) return;

  if (pw !== postPassword && pw !== MASTER_PASSWORD) {
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!");
    return;
  }

  if (!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;

  await db.from("posts").delete().eq("id", postId);
  alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤");
  location.href = "index.html";
};

/* ------------ ê¸€ ìˆ˜ì • ê¸°ëŠ¥ ------------ */

editBtn.onclick = () => {
  if (!editing) enterEditMode();
  else saveEdit();
};

function enterEditMode() {
  editing = true;

  const content = postContent.textContent;

  postContent.innerHTML = `
    <textarea id="editContent" style="width:100%; height:200px;">${content}</textarea>
    <p style="margin-top:15px; font-size:14px;">ğŸ“ íŒŒì¼ì„ ìƒˆë¡œ ì—…ë¡œë“œí•˜ë©´ ê¸°ì¡´ íŒŒì¼ì€ ëª¨ë‘ êµì²´ë©ë‹ˆë‹¤.</p>
    <input type="file" id="editFiles" accept="image/*,video/*" multiple>
  `;

  editBtn.textContent = "ì €ì¥í•˜ê¸°";
}

/* ì €ì¥ */
async function saveEdit() {
  const newContent = document.getElementById("editContent").value.trim();
  const newFiles = [...document.getElementById("editFiles").files];

  let urls = [];

  if (newFiles.length === 0) {
    const { data } = await db.from("posts")
      .select("file_url")
      .eq("id", postId)
      .single();
    urls = JSON.parse(data.file_url || "[]");
  } else {
    for (const file of newFiles) {
      const ext = file.name.split(".").pop();
      const path = `homework/${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;

      const { data: up } = await db.storage.from("uploads").upload(path, file);
      const { data: pub } = db.storage.from("uploads").getPublicUrl(up.path);

      urls.push(pub.publicUrl);
    }
  }

  await db.from("posts").update({
    content: newContent,
    file_url: JSON.stringify(urls)
  }).eq("id", postId);

  alert("ìˆ˜ì • ì™„ë£Œ!");
  location.reload();
}

/* ---- ì´ë¯¸ì§€ ëª¨ë‹¬ + ìŠ¬ë¼ì´ë“œ ---- */

function openImageModal(index) {
  if (!imageUrls.length) return;
  currentImageIndex = index;
  modalImage.src = imageUrls[currentImageIndex];
  imageModal.style.display = "flex";
}

function closeImageModal() {
  imageModal.style.display = "none";
}

function showPrevImage(event) {
  if (event) event.stopPropagation();
  if (!imageUrls.length) return;
  currentImageIndex = (currentImageIndex - 1 + imageUrls.length) % imageUrls.length;
  modalImage.src = imageUrls[currentImageIndex];
}

function showNextImage(event) {
  if (event) event.stopPropagation();
  if (!imageUrls.length) return;
  currentImageIndex = (currentImageIndex + 1) % imageUrls.length;
  modalImage.src = imageUrls[currentImageIndex];
}

/* í‚¤ë³´ë“œ ë°©í–¥í‚¤ë¡œë„ ìŠ¬ë¼ì´ë“œ */
document.addEventListener("keydown", (e) => {
  if (imageModal.style.display !== "flex") return;
  if (e.key === "ArrowLeft") {
    showPrevImage();
  } else if (e.key === "ArrowRight") {
    showNextImage();
  } else if (e.key === "Escape") {
    closeImageModal();
  }
});

/* ì´ˆê¸° */
loadPost();
loadComments();
</script>

</body>
</html>
